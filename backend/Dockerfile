FROM node:20-alpine

# Installer d√©pendances syst√®me n√©cessaires
RUN apk add --no-cache \
    python3 \
    py3-pip \
    ffmpeg \
    bash \
    shadow \
    netcat-openbsd \
    openssl

# Installer yt-dlp dans un virtualenv Python (optionnel)
RUN python3 -m venv /opt/venv \
    && /opt/venv/bin/pip install --upgrade pip \
    && /opt/venv/bin/pip install yt-dlp

ENV PATH="/opt/venv/bin:$PATH"

WORKDIR /app

# Copier package.json et prisma avant npm install (pour cache Docker)
COPY package*.json ./
COPY prisma ./prisma

# Installer d√©pendances Node.js
RUN npm install --legacy-peer-deps

# G√©n√©rer Prisma client
RUN npx prisma generate

# Copier le reste de l'application
COPY . .

EXPOSE 3000

CMD ["sh", "-c", "echo \"‚è≥ Waiting for database...\" && until nc -z db 5432; do sleep 1; done && echo \"üöÄ Running migrations...\" && npx prisma migrate deploy && echo \"üü¢ Starting server...\" && node src/server.js"]
